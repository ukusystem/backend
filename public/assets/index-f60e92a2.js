import{j as e,b9 as O,K as y,o as S,B as I,cs as T,G as u,bd as P,s as U,be as $,aP as K,W as Z,r as w,_ as B,S as R,I as V,a0 as W,a1 as q}from"./index-88bcf575.js";import{C as J}from"./CardHeader-3a056a5a.js";import{D as Q,M as L}from"./MenuItem-46d31063.js";import{d as k}from"./ArrowDropDownOutlined-ffc57e85.js";import{d as N}from"./CloseRounded-adf600ee.js";import{g as G}from"./groupByKey-ca6ec8a0.js";const F=({subTitle:t,title:a,stateType:s})=>e.jsx(O,{sx:{px:.5,py:1,margin:.5},elevation:2,children:e.jsxs(y,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsxs(y,{sx:{flex:1,overflow:"hidden"},children:[e.jsx(S,{variant:"h6",sx:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},children:a}),e.jsx(S,{variant:"caption",sx:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},children:t})]}),e.jsx(I,{sx:{width:40,height:40,borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",color:s==="warning"?"#D10000":s==="active"?"#16824C":"#767E75",backgroundColor:s==="warning"?"#FFBBBB":s==="active"?"#A0D9BC":"#bfbfbf"},children:e.jsx(X,{statetype:s,fontSize:"medium"})})]})});function X(t){return e.jsx(T,{...t,children:e.jsx("svg",{width:"16",height:"20",viewBox:"0 0 16 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:t.statetype==="warning"?"M5.9 13.5L8 11.4L10.1 13.5L11.5 12.1L9.4 10L11.5 7.9L10.1 6.5L8 8.6L5.9 6.5L4.5 7.9L6.6 10L4.5 12.1L5.9 13.5ZM8 20C5.68333 19.4167 3.77083 18.0875 2.2625 16.0125C0.754167 13.9375 0 11.6333 0 9.1V3L8 0L16 3V9.1C16 11.6333 15.2458 13.9375 13.7375 16.0125C12.2292 18.0875 10.3167 19.4167 8 20ZM8 17.9C9.73333 17.35 11.1667 16.25 12.3 14.6C13.4333 12.95 14 11.1167 14 9.1V4.375L8 2.125L2 4.375V9.1C2 11.1167 2.56667 12.95 3.7 14.6C4.83333 16.25 6.26667 17.35 8 17.9Z":"M6.95 13.55L12.6 7.9L11.175 6.475L6.95 10.7L4.85 8.6L3.425 10.025L6.95 13.55ZM8 20C5.68333 19.4167 3.77083 18.0875 2.2625 16.0125C0.754167 13.9375 0 11.6333 0 9.1V3L8 0L16 3V9.1C16 11.6333 15.2458 13.9375 13.7375 16.0125C12.2292 18.0875 10.3167 19.4167 8 20ZM8 17.9C9.73333 17.35 11.1667 16.25 12.3 14.6C13.4333 12.95 14 11.1167 14 9.1V4.375L8 2.125L2 4.375V9.1C2 11.1167 2.56667 12.95 3.7 14.6C4.83333 16.25 6.26667 17.35 8 17.9Z",fill:"currentColor"})})})}const Y=({modo:t,pines:a})=>e.jsxs(u,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",children:[e.jsx(u,{size:{xs:12},children:e.jsx(S,{variant:"subtitle1",component:"h4",children:"Pin Entrada"})}),Array.from(a).map(([s,g])=>e.jsx(u,{size:{xs:12,lg:6},children:e.jsx(F,{title:g.descripcion,subTitle:`Pin: ${g.pin}`,isAlarmActive:g.estado===1,stateType:t===P.Seguridad?g.estado===1?"warning":"active":g.estado===1?"active":"disable"})},s))]}),E=({camaras:t})=>e.jsxs(u,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",marginTop:1,children:[e.jsx(u,{size:{xs:12},children:e.jsx(S,{variant:"subtitle1",component:"h4",children:"Camaras"})}),Array.from(t).map(([a,s])=>e.jsx(u,{size:{xs:12,lg:6},children:e.jsx(F,{title:s.descripcion,subTitle:s.ip,isAlarmActive:s.conectado===0,stateType:s.conectado===0?"warning":"active"})},a))]}),D=U(O)(({theme:t,modo:a,seguridad:s})=>({display:"flex",flexDirection:"column",height:"100%",width:"100%",borderStyle:"solid",borderWidth:a===P.Seguridad?2:1,borderRadius:8,backgroundImage:"inherit",borderColor:a===P.Seguridad?s===$.Armado?"green":"darkgray":t.palette.mode==="dark"?t.palette.divider:t.palette.grey.A800,boxShadow:"inherit",":hover":{boxShadow:"inherit"},"& pre":{m:0,p:"16px !important",fontFamily:t.typography.fontFamily,fontSize:"0.75rem"}})),ee=({data:{camara:t,controlador:a,pin_entrada:s}})=>e.jsx(e.Fragment,{children:e.jsxs(D,{modo:a.modo,seguridad:a.seguridad,children:[e.jsx(J,{title:e.jsx(re,{controller:a}),sx:{p:1,margin:0,"& .MuiCardHeader-title":{py:1.5}}}),e.jsx(Q,{}),e.jsx(K,{sx:{flex:1,padding:1,"&:last-child":{paddingBottom:1},overflow:"hidden"},children:e.jsx(Z,{sx:{width:"100%",height:"100%"},children:e.jsxs(u,{container:!0,rowSpacing:1,columnSpacing:2,width:"100%",children:[e.jsxs(u,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",children:[e.jsx(u,{size:{xs:12},children:e.jsx(S,{variant:"subtitle1",component:"h4",children:"Pin Entrada"})}),e.jsx(u,{size:{xs:12,lg:6},children:e.jsx(F,{title:a.descripcion,subTitle:a.direccion,isAlarmActive:a.conectado===0,stateType:a.conectado===0?"warning":"active"})},a.ctrl_id)]}),s.size>0&&e.jsx(Y,{modo:a.modo,pines:s}),t.size>0&&e.jsx(E,{camaras:t})]})})})]})}),re=({controller:t})=>e.jsx(y,{direction:"row",spacing:2,alignItems:"center",sx:{position:"relative"},children:e.jsx(S,{variant:"h5",sx:{width:"100%",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",position:"absolute"},children:t.nodo})});var v=(t=>(t[t.Activo=1]="Activo",t[t.Desactivado=0]="Desactivado",t))(v||{});const ne=({regiones:t,sites:a,handleChangeFilter:s})=>{const[g,x]=w.useState(""),[j,M]=w.useState(""),_=o=>{x(o.target.value),s({rgn_id:o.target.value})},z=o=>{M(o.target.value),s({ctrl_id:o.target.value})};return e.jsxs(u,{container:!0,rowSpacing:2,px:2,pt:2,columnSpacing:2.75,alignItems:"center",children:[e.jsx(u,{size:{xs:12},children:e.jsx(S,{variant:"h5",children:"Alarmas"})}),e.jsxs(u,{size:{xs:12},container:!0,rowSpacing:3,columnSpacing:2.75,alignItems:"center",children:[e.jsx(u,{size:{xs:12,sm:6,md:4,lg:3},children:e.jsxs(y,{spacing:1,children:[e.jsx(B,{htmlFor:"group_site_alarm",sx:{display:"none"},children:"Grupo de sitio"}),e.jsxs(R,{displayEmpty:!0,value:g,onChange:_,inputProps:{id:"group_site_alarm"},renderValue:o=>{if(o.length===0)return e.jsx(e.Fragment,{children:"Grupo de sitio"});const m=t.find(C=>String(C.rgn_id)===String(o));return e.jsx(e.Fragment,{children:m?m.region:"No controlado"})},IconComponent:({...o})=>g!==""?e.jsx(V,{onClick:m=>{m.stopPropagation(),x(""),M(""),s({rgn_id:"",ctrl_id:""})},sx:{width:"1em",height:"1em",position:"absolute",right:7,top:"calc(50% - .5em)"},children:e.jsx(N,{fontSize:"small"})}):e.jsx(k,{...o}),MenuProps:{PaperProps:{style:{maxHeight:200}}},children:[e.jsx(L,{disabled:!0,value:"",children:e.jsx(e.Fragment,{children:"Grupo de sitio"})}),t.map((o,m)=>e.jsx(L,{value:String(o.rgn_id),children:e.jsx(I,{sx:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",width:"100%"},children:o.region})},m))]})]})}),e.jsx(u,{size:{xs:12,sm:6,md:4,lg:3},children:e.jsxs(y,{spacing:1,children:[e.jsx(B,{htmlFor:"site_item_alarm",sx:{display:"none"},children:"Sitio"}),e.jsxs(R,{disabled:g==="",displayEmpty:!0,value:j,onChange:z,inputProps:{id:"site_item_alarm"},renderValue:o=>{if(o.length===0)return e.jsx(e.Fragment,{children:"Sitio"});const m=a.find(C=>String(C.controlador.ctrl_id)===String(o));return e.jsx(e.Fragment,{children:m?m.controlador.nodo:"No controlado"})},IconComponent:({...o})=>j!==""?e.jsx(V,{onClick:m=>{m.stopPropagation(),M(""),s({ctrl_id:""})},sx:{width:"1em",height:"1em",position:"absolute",right:7,top:"calc(50% - .5em)"},children:e.jsx(N,{fontSize:"small"})}):e.jsx(k,{...o}),MenuProps:{PaperProps:{style:{maxHeight:200}}},children:[e.jsx(L,{disabled:!0,value:"",children:e.jsx(e.Fragment,{children:"Sitio"})}),g!==""&&G(a.map(o=>({...o,rgn_id:o.controlador.rgn_id})),"rgn_id")[g]&&G(a.map(o=>({...o,rgn_id:o.controlador.rgn_id})),"rgn_id")[g].map((o,m)=>e.jsx(L,{value:String(o.controlador.ctrl_id),children:e.jsx(I,{sx:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",width:"100%"},children:o.controlador.nodo})},m))]})]})})]})]})},ce=()=>{const[t,a]=w.useState(new Map),[s,g]=w.useState(new Map),x=w.useRef(null),[j,M]=w.useState(""),[_,z]=w.useState(""),o=w.useMemo(()=>{let n=Array.from(t.values());return j===""&&_===""||(j!==""&&(n=n.reduce((r,l)=>{const d=r,i=l;return j===String(i.controlador.rgn_id)&&d.push(i),d},[])),_!==""&&(n=n.reduce((r,l)=>{const d=r,i=l;return _===String(i.controlador.ctrl_id)&&d.push(i),d},[]))),n},[t,j,_]),m=w.useMemo(()=>Array.from(t).reduce((r,l)=>{const d=r,[,i]=l,p=s.get(i.controlador.rgn_id);return p!==void 0&&d.find(h=>h.rgn_id===i.controlador.rgn_id)===void 0&&d.push(p),d},[]),[s,t]),C=n=>{n.ctrl_id!==void 0&&z(n.ctrl_id),n.rgn_id!==void 0&&M(n.rgn_id)};return w.useEffect(()=>(x.current||(x.current=W(`${q}/alarm_notification`)),x.current.on("initial_data",(n,r)=>{const l=new Map;r.forEach(i=>{l.set(i.rgn_id,i)}),g(l);const d=new Map;Object.values(n).forEach(i=>{const{camara:p,controlador:c,pin_entrada:h}=i,f=p.map(A=>[A.cmr_id,A]),b=h.map(A=>[A.pe_id,A]),H={controlador:c,camara:new Map(f),pin_entrada:new Map(b)};d.set(c.ctrl_id,H)}),a(d)}),x.current.on("region",(n,r)=>{g(l=>{const d=new Map(l);return d.set(n,r),d})}),x.current.on("camera",(n,r,l)=>{a(d=>{const i=new Map(d),p=i.get(n);if(p!==void 0){const c={controlador:p.controlador,camara:new Map(p.camara),pin_entrada:new Map(p.pin_entrada)},h=c.camara.get(r.cmr_id);let f=!1;return l==="update"?h!==void 0&&(r.activo===v.Desactivado?c.camara.delete(r.cmr_id):r.activo===v.Activo&&(f=h.conectado!==r.conectado,c.camara.set(r.cmr_id,r))):l==="add"?h===void 0&&r.activo===v.Activo&&(f=r.conectado===1,c.camara.set(r.cmr_id,r)):l==="delete"&&c.camara.delete(r.cmr_id),f?(i.delete(n),new Map([[n,c],...i])):(i.set(n,c),i)}return d})}),x.current.on("controller",(n,r,l)=>{a(d=>{const i=new Map([...d]),p=i.get(n);if(p!==void 0){const c=p.controlador;let h=!1;if(l==="update"){h=c.conectado!==r.conectado;const f={controlador:r,camara:new Map(p.camara),pin_entrada:new Map(p.pin_entrada)};i.set(n,f)}else l==="delete"&&i.delete(n);if(h){i.delete(n);const f={controlador:r,camara:new Map(p.camara),pin_entrada:new Map(p.pin_entrada)};return new Map([[n,f],...i])}return i}else if(l==="add"&&r.activo===1){const c={camara:new Map,controlador:r,pin_entrada:new Map};return new Map([[n,c],...i])}return d})}),x.current.on("pin_entrada",(n,r,l)=>{a(d=>{const i=new Map(d),p=i.get(n);if(p!==void 0){const c={controlador:p.controlador,camara:new Map(p.camara),pin_entrada:new Map(p.pin_entrada)},h=c.pin_entrada.get(r.pe_id);let f=!1;return l==="update"?h!==void 0&&(r.activo===v.Desactivado?c.pin_entrada.delete(r.pe_id):r.activo===v.Activo&&(f=h.estado!==r.estado,c.pin_entrada.set(r.pe_id,r))):l==="add"?h===void 0&&r.activo===v.Activo&&(f=r.estado===1,c.pin_entrada.set(r.pe_id,r)):l==="delete"&&c.pin_entrada.delete(r.pe_id),f?(i.delete(n),new Map([[n,c],...i])):(i.set(n,c),i)}return d})}),()=>{x.current&&(x.current.disconnect(),x.current=null)}),[]),e.jsx(e.Fragment,{children:e.jsxs(I,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",gap:2},children:[e.jsx(ne,{regiones:m,sites:Array.from(t.values()),handleChangeFilter:C}),e.jsx(Z,{sx:{width:"100%",height:"100%",flex:1},children:e.jsx(u,{container:!0,rowSpacing:2,columnSpacing:2,padding:2,sx:{width:"100%"},children:o.map(n=>e.jsx(u,{component:"div",height:250,size:{xs:12,sm:6,md:4},children:e.jsx(ee,{data:n})},n.controlador.ctrl_id))})})]})})};export{ce as default};
